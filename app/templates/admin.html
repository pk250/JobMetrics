<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智聘云析 - 后台管理</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <link rel="stylesheet" href="/static/css/bootstrap-icons.css">
    <style>
        .sidebar {
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            padding: 48px 0 0;
            box-shadow: inset -1px 0 0 rgba(0, 0, 0, .1);
        }
        .sidebar-sticky {
            position: relative;
            top: 0;
            height: calc(100vh - 48px);
            padding-top: .5rem;
            overflow-x: hidden;
            overflow-y: auto;
        }
        .nav-link {
            font-weight: 500;
            color: #333;
        }
        .nav-link.active {
            color: #007bff;
        }
        main {
            padding-top: 48px;
        }
        .table-responsive {
            margin-bottom: 1rem;
        }
        #content-area {
            padding: 20px;
        }
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <header class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">智聘云析</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarMenu">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="navbar-nav">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3 text-white" href="#">退出</a>
            </div>
        </div>
    </header>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
                <div class="position-sticky pt-3 sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="dashboard">
                                <i class="bi bi-speedometer2 me-2"></i>仪表盘
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="spiders">
                                <i class="bi bi-bug me-2"></i>爬虫管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="schedules">
                                <i class="bi bi-calendar-check me-2"></i>调度规则
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="environments">
                                <i class="bi bi-gear me-2"></i>环境变量
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="logs">
                                <i class="bi bi-file-text me-2"></i>执行日志
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4" style="padding-top: 20px;">
                <iframe id="content-frame" style="width: 100%; height: calc(100vh - 72px); border: none; padding: 0 15px;"></iframe>
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p>加载中...</p>
                </div>
            </main>
        </div>
    </div>

    <!-- 模板 - 仪表盘 -->
    <template id="template-dashboard">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">仪表盘</h1>
        </div>
        <div class="row">
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">爬虫总数</h5>
                        <p class="card-text fs-1 text-center" id="spider-count">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">调度任务总数</h5>
                        <p class="card-text fs-1 text-center" id="schedule-count">-</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">执行成功率</h5>
                        <p class="card-text fs-1 text-center" id="success-rate">-</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        最近执行日志
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>爬虫名称</th>
                                        <th>开始时间</th>
                                        <th>结束时间</th>
                                        <th>状态</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-logs">
                                    <!-- 数据将通过JavaScript动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- 模板 - 爬虫管理 -->
    <template id="template-spiders">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">爬虫管理</h1>
            <div class="d-flex gap-2">
                <div class="input-group">
                    <input type="text" class="form-control" id="spiderSearch" placeholder="搜索爬虫...">
                    <button class="btn btn-outline-secondary" type="button" id="searchSpider">搜索</button>
                </div>
                <button class="btn btn-primary" id="btn-add-spider">添加爬虫</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>描述</th>
                        <th>脚本路径</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="spider-list">
                    <!-- 数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
            <!-- 分页控件 -->
            <div id="environment-pagination" class="mt-3">
                <!-- 分页将通过JavaScript动态加载 -->
            </div>
        </div>
    </template>

    <!-- 模板 - 调度规则 -->
    <template id="template-schedules">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">调度规则</h1>
            <button class="btn btn-primary" id="btn-add-schedule">添加调度</button>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>爬虫名称</th>
                        <th>Cron表达式</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="schedule-list">
                    <!-- 数据将通过JavaScript动态加载 -->
                    </tbody>
                    </table>
                    </div>
                    <!-- 分页控件 -->
                    <div id="schedule-pagination" class="mt-3">
                    <!-- 分页将通过JavaScript动态加载 -->
                    </div>
                    </template>

                    <!-- 模板 - 环境变量 -->
    <template id="template-environments">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">环境变量</h1>
            <button class="btn btn-primary" id="btn-add-environment">添加环境</button>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>名称</th>
                        <th>描述</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="environment-list">
                    <!-- 数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
            <!-- 分页控件 -->
            <div id="environment-pagination" class="mt-3">
                <!-- 分页将通过JavaScript动态加载 -->
            </div>
        </div>
    </template>

    <!-- 模板 - 执行日志 -->
    <template id="template-logs">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">执行日志</h1>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-sm">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>爬虫名称</th>
                        <th>开始时间</th>
                        <th>结束时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="log-list">
                    <!-- 数据将通过JavaScript动态加载 -->
                </tbody>
            </table>
            <!-- 分页控件 -->
            <div id="environment-pagination" class="mt-3">
                <!-- 分页将通过JavaScript动态加载 -->
            </div>
        </div>
        <!-- 分页控件 -->
        <div id="log-pagination" class="mt-3">
            <!-- 分页将通过JavaScript动态加载 -->
        </div>
    </template>

    <!-- 模态框 - 爬虫表单 -->
    <div class="modal fade" id="spiderModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="spiderModalTitle">添加爬虫</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="spiderForm">
                        <input type="hidden" id="spiderId">
                        <div class="mb-3">
                            <label for="spiderName" class="form-label">名称</label>
                            <input type="text" class="form-control" id="spiderName" required>
                        </div>
                        <div class="mb-3">
                            <label for="spiderDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="spiderDescription"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="spiderScriptPath" class="form-label">脚本路径</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="spiderScriptPath" required>
                                <button class="btn btn-outline-secondary" type="button" id="uploadScript">
                                    <i class="bi bi-upload"></i> 上传
                                </button>
                                <button class="btn btn-outline-secondary" type="button" id="editScript">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                            </div>
                            <input type="file" id="scriptFileInput" accept=".py" style="display: none;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label d-flex justify-content-between align-items-center">
                                <span>状态</span>
                            </label>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="spiderIsActive">
                                <label class="form-check-label" for="spiderIsActive">启用</label>
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="spiderIsActive" checked>
                            <label class="form-check-label" for="spiderIsActive">激活</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveSpider">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 - 调度表单 -->
    <div class="modal fade" id="scheduleModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scheduleModalTitle">添加调度</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="scheduleForm">
                        <input type="hidden" id="scheduleId">
                        <div class="mb-3">
                            <label for="scheduleSpiderId" class="form-label">爬虫</label>
                            <select class="form-select" id="scheduleSpiderId" required>
                                <!-- 选项将通过JavaScript动态加载 -->
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="scheduleCronExpression" class="form-label">Cron表达式</label>
                            <input type="text" class="form-control" id="scheduleCronExpression" required>
                            <div class="form-text">例如: */5 * * * * (每5分钟执行一次)</div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="scheduleIsActive" checked>
                            <label class="form-check-label" for="scheduleIsActive">激活</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveSchedule">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 - 环境变量表单 -->
    <div class="modal fade" id="environmentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="environmentModalTitle">添加环境变量</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="environmentForm">
                        <input type="hidden" id="environmentId">
                        <div class="mb-3">
                            <label for="environmentName" class="form-label">名称</label>
                            <input type="text" class="form-control" id="environmentName" required>
                        </div>
                        <div class="mb-3">
                            <label for="environmentValue" class="form-label">值</label>
                            <input type="text" class="form-control" id="environmentValue" required>
                        </div>
                        <div class="mb-3">
                            <label for="environmentDescription" class="form-label">描述</label>
                            <textarea class="form-control" id="environmentDescription"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveEnvironment">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 - 日志详情 -->
    <div class="modal fade" id="logDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">执行日志详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <th style="width: 120px;">爬虫名称</th>
                                <td id="logDetailSpiderName">-</td>
                            </tr>
                            <tr>
                                <th>开始时间</th>
                                <td id="logDetailStartTime">-</td>
                            </tr>
                            <tr>
                                <th>结束时间</th>
                                <td id="logDetailEndTime">-</td>
                            </tr>
                            <tr>
                                <th>状态</th>
                                <td id="logDetailStatus">-</td>
                            </tr>
                        </table>
                    </div>
                    <div class="mb-3">
                        <h6>输出内容</h6>
                        <pre id="logDetailOutput" class="bg-dark text-light p-3" style="max-height: 300px; overflow-y: auto;">-</pre>
                    </div>
                    <div>
                        <h6>错误信息</h6>
                        <pre id="logDetailError" class="bg-dark text-light p-3" style="max-height: 200px; overflow-y: auto;">-</pre>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 警告提示 -->
    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 5">
        <div id="alertToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto" id="alertTitle">提示</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="alertMessage"></div>
        </div>
    </div>

    <!-- JavaScript 依赖 -->
    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/script-editor.js"></script>
    <script src="/static/js/admin.js"></script>
    <script>
    // 导航菜单激活状态切换
    document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            document.querySelectorAll('.nav-link').forEach(item => item.classList.remove('active'));
            this.classList.add('active');
            const page = this.dataset.page;
            document.getElementById('content-frame').src = `/admin/${page}`;
        });
    });
    </script>
</body>
</html>
<div id="content-area">
    <!-- 内容将通过JavaScript动态加载 -->
</div>
<iframe id="content-iframe" style="width: 100%; height: calc(100vh - 60px); border: none"></iframe>